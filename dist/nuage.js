Object.extend=function(c,b){if(typeof(b)!="undefined"){for(var a in b){c[a]=b[a]}}return c};Object.extend(Object,{clone:function(b){if(b instanceof Array){var c=[]}else{var c={}}for(var a in b){c[a]=b[a]}return c}});Function.prototype.to_method=function(){var a=this;var b=arguments[0];return function(){var e=[b],d=arguments;for(var g=0,c=d.length;g<c;g++){e.push(d[g])}return a.apply(b,e)}};Object.extend(window,{__type__:{"nuage.object":function(){}},$:function(a){if(isinstance(a,String)){return document.querySelector(a)}return a},len:function(a){if(a==null){throw exc.TypeError("TypeError: null has no len()")}if(a instanceof Function){throw exc.TypeError("TypeError: function has no len()")}if(a.__class__&&isinstance(a,list)){return a._values.length}if(a.__class__&&isinstance(a,dict)){return len(a.keys())}if(typeof(a.length)!="undefined"){return a.length}return len(dict(a).keys())},print:function(){msg=list();for(var b=0,a=arguments.length;b<a;b++){msg.append(arguments[b])}console.log("\xA0".join(msg))},pprint:function(){msg=list();for(var b=0,a=arguments.length;b<a;b++){if(isinstance(arguments[b],Object)){if(msg._values.length){console.log("\xA0".join(msg))}console.log(arguments[b]);msg=list()}else{msg.append(arguments[b])}}if(msg._values.length){console.log("\xA0".join(msg))}},callable:function(a){return nuage.isinstance(a,Function)},isinstance:function(b,a){return nuage.isinstance(b,a)},issubclass:function(b,a){return nuage.issubclass(b,a)},type:function(a){if(a instanceof Array){return Array}return a.__class__},hasattr:function(b,a){return(typeof(b[a])!="undefined")},getattr:function(b,a){return b[a]},rand:function(b,a){if(a==null){a=b;b=0}if(!a){a=1}return b+Math.floor(Math.random()*a)},range:function(e,b,c){if(arguments.length<3){c=1}if(arguments.length<2){b=e;e=0}if(c==0){throw exc.ValueError("ValueError: range() step argument must not be zero")}var d=[];if(c>0){for(var a=e;a<b;a+=c){d.push(a)}}else{for(var a=e;a>b;a+=c){d.push(a)}}return d},zip:function(d){var h=list();var e=0;var c=true;while(c){var g=list();for(var b=0;b<arguments.length;b++){var a=arguments[b];c=(len(a)<e);if(!c){if(a instanceof list){g.append(a.get(e))}else{g.append(a[e])}}else{break}}if(c){h.append(g)}e+=1}return h},map:function(g,b){var d=list();var a=b.__iter__();try{while(true){d.append(g(a.next()))}}catch(c){if(!nuage.isinstance(c,exc.StopIteration)){throw c}}return d},str:function(a){if(a==null){return"null"}return a.toString()},int_:function(a){var b=parseInt(a,10);if(isNaN(b)){throw exc.ValueError()}return b},float_:function(a){var b=parseFloat(a,10);if(isNaN(b)){throw exc.ValueError()}return b}});window.nuage={_ancestors:{"nuage.object":[]},_static:{"nuage.object":{__lt__:function(b,a){return(b<a)},__gt__:function(b,a){return(a>b)},toString:function(){return"<class {0}>".format(this.__fullname__)}}},_native_methods:{"window.String":["replace"]},_impl:{"nuage.object":{__init__:function(a){},__str__:function(){return"<{0} object>".format(this.__class__.__fullname__)}}},create_module:function(c){var b={__name__:"window",__impl__:{}};Object.extend(b,c);var a=this._create_module(b.__name__);Object.extend(a,b.__impl__)},create_class:function(e){var c={__module__:"window",__name__:null,__static__:{},__parent__:[],__impl__:{},};e=Object.extend(c,e);if(e.__name__==null){throw"__name__ is missing"}if(e.__module__==null){e.__module__=window}var d=this._create_module(e.__module__);var r=e.__module__+"."+e.__name__;this._static[r]=e.__static__;this._impl[r]=e.__impl__;this._ancestors[r]=[];if(!(e.__parent__ instanceof Array)){e.__parent__=[e.__parent__]}if(e.__parent__.length==0){e.__parent__.push(nuage.object)}for(var k in e.__parent__){var n=e.__parent__[k];if(!n){throw exc.Exception(r+" has undefined parent class")}for(var g in this._ancestors[n.__fullname__]){this._ancestors[r].push(this._ancestors[n.__fullname__][g])}this._ancestors[r].push(n)}var h=this;__type__[r]=function(u){var x=this;for(var w in h._ancestors[r]){var s=h._ancestors[r][w].__fullname__;if(h._native_methods[s]){var v=h._impl[s];var y=h._native_methods[s];for(var p in y){x[y[p]]=v[y[p]].to_method(x)}}var j=h._impl[s];if(j.__val__){x.valueOf=j.__val__.to_method(x)}if(j.__str__){x.toString=j.__str__.to_method(x)}for(var t in j){if(j[t] instanceof Function){if((t!="toString")&&(t!="valueOf")){x[t]=j[t].to_method(x)}}else{x[t]=j[t]}}}for(var t in e.__impl__){if(e.__impl__[t] instanceof Function){if((t!="toString")&&(t!="valueOf")){x[t]=e.__impl__[t].to_method(x)}}else{x[t]=e.__impl__[t]}}if(e.__impl__.__str__){x.toString=e.__impl__.__str__.to_method(x);x.valueOf=e.__impl__.__str__.to_method(x)}x.__class__=d[e.__name__];x.__init__.apply(x,arguments[0]);return x};var b=e.__name__;d[b]=function(){return new __type__[r](arguments)};for(var q in this._ancestors[r]){Object.extend(d[e.__name__],this._static[this._ancestors[r][q].__fullname__])}Object.extend(d[b],e.__static__);d[b].__name__=e.__name__;d[b].__fullname__=e.__module__+"."+b;for(var l in e.__impl__){if(e.__impl__[l] instanceof Function){if((l!="toString")&&(l!="__valueOf__")){d[b][l]=e.__impl__[l]}}}return d[e.__name__]},_create_module:function(a){if(isinstance(a,Object)){return a}var c=a.split(/\./g);var d=window;for(var b=0;b<c.length;b++){if(!hasattr(d,c[b])){d[c[b]]={}}d=d[c[b]]}return d},isinstance:function(b,a){if(a==null){throw exc.TypeError("TypeError: isinstance expected 2 arguments, got 1")}if(b instanceof a){return true}if(b==null){return false}switch(typeof b){case"boolean":return a.__fullname__=="window.Boolean";case"number":return a.__fullname__=="window.Number";break;case"string":return a.__fullname__=="window.String";break}if(b instanceof __type__[a.__fullname__]){return true}if(!b.__class__){return false}return(list(this._ancestors[b.__class__.__fullname__]).index(a)>=0)},issubclass:function(b,a){if(b==a){return true}return(list(this._ancestors[b.__fullname__]).index(a)>=0)},};nuage.object=function(){return new __type__["nuage.object"]()};nuage.object.__name__="object";nuage.object.__fullname__="nuage.object";nuage.builtin_proto={__init__:function(a,b){a._value=b},__val__:function(a){return a._value},__str__:function(a){return a._value.toString()},__lt__:function(b,a){if(arguments.length<2){return this<b}else{return(b._value<a._value)}},__gt__:function(b,a){if(arguments.length<2){return this>b}else{return(b._value>a._value)}}};Object.extend(Date,{__name__:"Date",__module__:"window",__fullname__:"window.Date"});Object.extend(Date.prototype,{__class__:Date});Object.extend(Date.prototype,nuage.builtin_proto);nuage._impl["window.Date"]=Date.prototype;nuage._ancestors["window.Date"]=[];Object.extend(Boolean,{__name__:"Boolean",__module__:"window",__fullname__:"window.Boolean"});Object.extend(Boolean.prototype,{__class__:Boolean});Object.extend(Boolean.prototype,nuage.builtin_proto);__type__["window.Boolean"]=Boolean;nuage._static["window.Boolean"]=Boolean;nuage._impl["window.Boolean"]=Boolean.prototype;nuage._ancestors["window.Boolean"]=[];Object.extend(Number,{__name__:"Number",__module__:"window",__fullname__:"window.Number"});Object.extend(Number.prototype,{__class__:Number});Object.extend(Number.prototype,nuage.builtin_proto);__type__["window.Number"]=Number;nuage._static["window.Number"]=Number;nuage._impl["window.Number"]=Number.prototype;nuage._ancestors["window.Number"]=[];Object.extend(String,{__name__:"String",__module__:"window",__fullname__:"window.String",});String.prototype.replace_=String.prototype.replace;String.prototype.split_=String.prototype.split;Object.extend(String.prototype,nuage.builtin_proto);Object.extend(String.prototype,{__class__:String,strip:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return a.replace(/^(\s|\xA0)+|(\s|\xA0)+$/g,"")},lstrip:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return a.replace(/^(\s|\xA0)+/,"")},rstrip:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return a.replace(/(\s|\xA0)+$/,"")},join:function(b,e){if(arguments.length<2){e=arguments[0];b=this}var g="";if(len(e)>0){var a;if(e instanceof __type__["window.list"]){a=e.values()}else{a=e}for(var c=0,d=a.length-1;c<d;c++){g+=a[c]+this}g+=a[a.length-1]}return g},cut:function(a,d,b){if(a==this){var c=a._value}else{var c=this;b=d;d=a}if(b==null){if(d>0){b=d;d=0}else{b=c.length}}if(d<0){d=c.length+d}if(b<=0){b=c.length+b}d=Math.max(d,0);b=Math.min(b,c.length);return c.substring(d,b)},split:function(a,b){if(arguments.length<2){b=arguments[0];a=this}if(!b){b=/\s+|\xA0+/gim}return a.split_(b)},startswith:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return(a.index(b)==0)},endswith:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return((a.cut(-b.length))==b)},index:function(a,c){if(arguments.length<2){c=arguments[0];var b=this}else{var b=a._value}return b.indexOf(c)},capitalize:function(a){if(arguments.length<1){var b=this}else{var b=a._value}return b.substring(0,1).toUpperCase()+b.substring(1,b.length-1)},format:function(k,h){if(k===this){if(isinstance(arguments[1],String)){var g=[];for(var e=1;e<arguments.length;e++){g.push(arguments[e])}h=g}var d=k}else{if(isinstance(arguments[0],String)){var g=[];for(var e=0;e<arguments.length;e++){g.push(arguments[e])}h=g}else{h=arguments[0]}var d=this}var j;var b=list();var c=d.split(/\{|\}/gm);var a=false;if(isinstance(h,dict)){h=h.to_object()}else{if(isinstance(h,list)){h=h.values()}}for(var e=0;e<c.length;e++){if(a){j=h[c[e]];if(len(j)){b.append(j)}}else{if(len(c[e])){b.append(c[e])}}a=!a}return"".join(b)},lower:function(a){if(arguments.length<1){var b=this}else{var b=a._value}return b.toLowerCase()},upper:function(a){if(arguments.length<1){var b=this}else{var b=a._value}return b.toUpperCase()},replace:function(a,b,d){if(arguments.length<3){var d=arguments[1];var b=arguments[0];var c=this}else{var c=a._value}if(isinstance(b,String)){b=new RegExp(b,"gm")}return c.replace_(b,d)},ljust:function(b,d,a){if(b==this){if(arguments.length>2){a=arguments[2]}else{a="\xA0"}d=arguments[1];var c=b}else{if(arguments.length>1){a=arguments[1]}else{a="\xA0"}d=arguments[0];var c=this}while(len(c)<d){c=a+c}return c},rjust:function(b,d,a){if(b==this){if(arguments.length>2){a=arguments[2]}else{a="\xA0"}d=arguments[1];var c=b}else{if(arguments.length>1){a=arguments[1]}else{a="\xA0"}d=arguments[0];var c=this}while(len(c)<d){c=c+a}return c},zfill:function(a,c){if(a!==this){c=a;var b=this}else{var b=a._value}return b.ljust(b,c,"0")}});__type__["window.String"]=String;nuage._impl["window.String"]=String.prototype;nuage._ancestors["window.String"]=[];Object.extend(RegExp,{__name__:"RegExp",__module__:"window",__fullname__:"window.RegExp"});Object.extend(RegExp.prototype,nuage.builtin_proto);Object.extend(RegExp.prototype,{__class__:RegExp,__init__:function(a){},__lt__:function(b,a){return(b<a)},__gt__:function(b,a){return(b>a)},match:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return a.test(b)},search:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return a.exec(b)},split:function(a,b){if(arguments.length<2){b=arguments[0];a=this}return b.split(a)}});__type__["window.RegExp"]=RegExp;nuage._impl["window.RegExp"]=RegExp.prototype;nuage._ancestors["window.RegExp"]=[];nuage.create_module({__name__:"re",__impl__:{compile:function(b,a){return new RegExp(b,a)}}});nuage.create_class({__name__:"Exception",__module__:"exc",__impl__:{__init__:function(a,b){if(b&&isinstance(b,String)){a.message=b}else{a.message="Exception "+a.__class__.__name__+" occured"}},__str__:function(a){return a.__class__.__name__+":"+a.message}}});nuage.create_class({__name__:"StopIteration",__module__:"exc",__parent__:exc.Exception});nuage.create_class({__name__:"StandardError",__module__:"exc",__parent__:exc.Exception,__impl__:{__init__:function(a,b){exc.Exception.__init__(b||"Error "+a.__class__.__name__+" occured")}}});nuage.create_class({__name__:"LookupError",__module__:"exc",__parent__:exc.StandardError});nuage.create_class({__name__:"IndexError",__module__:"exc",__parent__:exc.LookupError});nuage.create_class({__name__:"KeyError",__module__:"exc",__parent__:exc.LookupError});nuage.create_class({__name__:"TypeError",__module__:"exc",__parent__:exc.StandardError,__impl__:{__init__:function(a,b){exc.StandardError.__init__(b||"Error "+a.__class__.__name__+" occured")}}});nuage.create_class({__name__:"AttributeError",__module__:"exc",__parent__:exc.StandardError});nuage.create_class({__name__:"ValueError",__module__:"exc",__parent__:exc.StandardError});nuage.create_class({__name__:"datetime",__static__:{now:function(){return datetime(new Date())}},__impl__:{__init__:function(c,g,h,b,a,i,d,e){if(g instanceof Date){c._value=g}else{if(arguments.length<4){throw exc.TypeError("year, month, day are required")}if(h){h--}a=a||0;i=i||0;d=d||0;e=e||0;c._value=new Date(g,h,b,a,i,d,e)}},__str__:function(a){var b=a._value.getFullYear()+"-";b+=str(a._value.getMonth()+1).zfill(2)+"-";b+=str(a._value.getDate()).zfill(2)+" ";b+=str(a._value.getHours()).zfill(2)+":";b+=str(a._value.getMinutes()).zfill(2)+":";b+=str(a._value.getSeconds()).zfill(2)+".";b+=str(a._value.getMilliseconds()).zfill(3);return b},isoformat:function(a){var b=a._value.getFullYear()+"-";b+=str(a._value.getMonth()+1).zfill(2)+"-";b+=str(a._value.getDate()).zfill(2)+"T";b+=str(a._value.getHours()).zfill(2)+":";b+=str(a._value.getMinutes()).zfill(2)+":";b+=str(a._value.getSeconds()).zfill(2)+".";b+=str(a._value.getMilliseconds()).zfill(3);return b}}});nuage.create_class({__name__:"list",__impl__:{__init__:function(c,b){if(b instanceof Array){c._values=b}else{c._values=[];for(var d=1,a=arguments.length;d<a;d++){c._values.push(arguments[d])}}},__iter__:function(a){return nuage.ListIterator(a)},get:function(a,b){if(b<0){b=a._values.length+b}if((b<0)||(b>len(a))){throw exc.IndexError("IndexError: list index out of range")}return a._values[b]},set:function(a,c,b){a._values[c]=b},values:function(a){return a._values},clear:function(a){a._values.length=0;return a},insert:function(b,g,e){var a=[];if(g<0){g=b._values.length+g}if(g<0){g=0}if(g<b._values.length){for(var c=0,d=b._values.length;c<d;c++){if(c==g){a.push(e)}a.push(b._values[c])}b._values=a}else{b._values.push(e)}},append:function(a,b){a._values.push(b)},pop:function(b,g){if((len(arguments)==1)||(len(b)==g)){return b._values.pop()}if(g==0){return b._values.shift()}if(g<0){g=len(b)+g}if((g<0)||(g>len(b))){throw exc.IndexError("pop index out of range")}var e=b._values[g];var a=[];for(var c=0,d=b._values.length;c<d;c++){if(c!=g){a.push(b._values[c])}}b._values=a;return e},copy:function(b){var d=[];for(var c=0,a=b._values.length;c<a;c++){d.push(b._values[c])}return list(d)},extend:function(a,d){if(d instanceof __type__["window.list"]){for(var b=0,c=len(d);b<c;b++){a._values.push(d.get(b))}}else{for(var b=0,c=len(d);b<c;b++){a._values.push(d[b])}}return a},cut:function(a,e,c){if(e<0){e=a._values.length+e}e=Math.max(e,0);if(arguments.length==1){c=a._values.length}else{if(c<0){c=a._values.length+c}}c=Math.min(c,a._values.length);var d=[];for(var b=e;b<c;b++){d.push(a._values[b])}return list(d)},delete_:function(b,g,d){if(g<0){g=b._values.length+g}g=Math.max(g,0);if(arguments.length==1){d=b._values.length}else{if(d<0){d=b._values.length+d}}d=Math.min(d,b._values.length);var a=[];var c=0;var e=b._values.length;for(var c=0,e=g;c<e;c++){a.push(b._values[c])}for(var c=d,e=b._values.length;c<e;c++){a.push(b._values[c])}b._values=a},remove:function(b,e){var a=[];var c=0;var d=b._values.length;for(;c<d;c++){if(b._values[c]!==e){a.push(b._values[c])}else{c++;break}}for(;c<d;c++){a.push(b._values[c])}b._values=a},index:function(a,d){for(var b=0,c=a._values.length;b<c;b++){if(a._values[b]===d){return b}}return -1},reverse:function(b){var a=[];for(var c=b._values.length-1;c>=0;c--){a.push(b._values[c])}b._values=a},sort:function(a,b){if(!(b instanceof Function)){b=function(d,c){if(d.__lt__(c)){return -1}if(d.__gt__(c)){return 1}return 0};a._values.sort(b)}else{a._values.sort(b)}},__str__:function(a){return"["+", ".join(a)+"]"}}});nuage.create_class({__name__:"dict",__impl__:{__init__:function(b,a){b.clear();if(a){b.update(a)}},__iter__:function(b){var a=b.items();return nuage.ListIterator(list(a))},__str__:function(c){var e="{";for(var d=0,a=len(c._keys);d<a;d++){e+='"'+c._keys[d]+'":';if(c._values[d]!=null){var b=c._values[d]}else{var b=c._defaults[d]}if(isinstance(c._values[d],String)){e+='"'+b+'"'}else{e+=str(b)}if(d+1<a){e+=","}}e+="}";return e},clear:function(a){a._keys=[];a._defaults=[];a._values=[]},keys:function(a){return list(a._keys)},values:function(self){var rv=list();for(var i=0 in self._keys){if(self._values[i]!=null){rv.append(self._values[i])}else{rv.append(self._defaults[i])}}return rv},items:function(self){var rv=[];for(var i=0 in self._keys){var _value={};if(self._values[i]!=null){_value[self._keys[i]]=self._values[i]}else{_value[self._keys[i]]=self._defaults[i]}rv.push(_value)}return rv},to_object:function(self){var rv={};for(var i=0 in self._keys){if(self._values[i]!=null){rv[self._keys[i]]=self._values[i]}else{rv[self._keys[i]]=self._defaults[i]}}return rv},has_key:function(self,key){return((list(self._keys)).index(key))>=0},get:function(self,key,default_){var i=(list(self._keys)).index(key);if(i<0){if(arguments.length>2){return default_}throw exc.KeyError()}if(self._values[i]!=null){return self._values[i]}else{return self._defaults[i]}},set:function(self,key,value){var i=(list(self._keys)).index(key);if(i<0){self._keys.push(key);self._values.push(value);self._defaults.push(null)}else{self._values[i]=value;self._defaults[i]=null}return self},setdefault:function(self,key,default_){var i=(list(self._keys)).index(key);if(i<0){self._keys.push(key);self._values.push(null);self._defaults.push(default_);return default_}else{self._defaults[i]=default_;if(self._values[i]!=null){default_=self._values[i]}return default_}},delete_:function(self,key){var i=(list(self._keys)).index(key);if(i<0){return}self._keys.pop(i);self._values.pop(i);self._defaults.pop(i)},update:function(self,obj){if(obj instanceof Array){obj=list(obj)}if(obj instanceof __type__["window.dict"]){for(var k in obj._keys){if(self.has_key(obj._keys[k])){self._defaults[obj._keys[k]]=obj._defaults[obj._keys[k]];self._values[obj._keys[k]]=obj._values[obj._keys[k]]}else{self._keys.push(obj._keys[k]);var i=list(obj._keys).index(k);self._defaults.push(obj._defaults[i]);self._values.push(obj._values[i])}}}else{if(obj instanceof list){for(var i=0,l=len(obj);i<l;i++){var oo=obj.get(i);if(len(oo)!=2){throw exc.ValueError("dictionnary update")}if(obj instanceof list){self_values[oo.get(0)]=oo.get(1);if(self.has_key(oo.get(0))){self._defaults[oo.get(0)]=null;self._values[oo.get(0)]=oo.get(1)}else{self._keys.push(oo.get(0));self._defaults.push(null);self._values[k].push(oo.get(1))}}else{self_values[oo[0]]=oo[1];if(self.has_key(oo[0])){self._defaults[oo[0]]=null;self._values[oo[0]]=oo[1]}else{self._keys.push(oo[0]);self._defaults.push(null);self._values[k].push(oo[1])}}}}else{for(var k in obj){if(self.has_key(k)){self._defaults[k]=null;self._values[k]=obj[k]}else{self._keys.push(k);self._defaults.push(null);self._values.push(obj[k])}}}}}}});nuage.create_class({__name__:"ListIterator",__module__:"nuage",__impl__:{__init__:function(self,list_){self.idx=0;self.list=list_},next:function(self){if(self.idx>=len(self.list)){throw exc.StopIteration()}var rv=self.list.get(self.idx);self.idx++;return rv}}});nuage.create_module({__name__:"json",__impl__:{dumps:function(obj,options,done){if(arguments.length==3){if(done.index(obj)>=0){return'"__recurs__"'}var opt=options}else{var opt=Object.extend(options||{},{display_function:false,display_null:true,display_private:false});done=list()}done.append(obj);if(isinstance(obj,list)){obj=obj._values}if(isinstance(obj,dict)){obj=str(obj)}var obj_=!(obj instanceof Array);var rvlist=list();var s="";for(var p in obj){if(!obj_||(obj_&&opt.display_private||(!opt.display_private&&(p.cut(1)!="_")))){var type=typeof(obj[p]);s="";switch(type){case"object":if(obj[p]!=null){if(obj[p] instanceof Date){if(obj_){s+='"'+p+'":"'}s+=obj[p].getFullYear()+"-";s+=str(obj[p].getMonth()+1).zfill(2)+"-";s+=str(obj[p].getDay()).zfill(2)+"T";s+=str(obj[p].getHours()).zfill(2)+":";s+=str(obj[p].getMinutes()).zfill(2)+":";s+=str(obj[p].getSeconds()).zfill(2)+".";s+=str(obj[p].getMilliseconds()).zfill(3)+'"'}else{if(obj_){s+='"'+p+'":'}if(isinstance(obj[p],datetime)){s+='"'+obj[p].isoformat()+'"'}else{s+=json.dumps(obj[p],opt,done)}}}else{if(opt.display_null){if(obj_){s+='"'+p+'":'}s+="null"}}break;case"function":if(opt.displayFunction){if(obj_){s+='"'+p+'":'}s+=obj[p]}break;case"boolean":case"number":if(obj_){s+='"'+p+'":'}s+=obj[p];break;default:if(obj_){s+='"'+p+'":'}s+='"'+obj[p]+'"';break}if(len(s)){rvlist.append(s)}}}if(obj_){var rv="{"+",".join(rvlist)+"}"}else{var rv="["+",".join(rvlist)+"]"}return rv},load:function(str_){return eval("("+str_+")")}}});nuage.create_module({__name__:"base64",__impl__:{b64encode:function(str){return btoa(str)},b64decode:function(b64){return atob(b64)},}});nuage.create_module({__name__:"evt.dom",__impl__:{hooked:list(),hook:function(node,name,callback,args__){var args=list();for(var i=3,l=len(arguments);i<l;i++){args.append(arguments[i])}function cb(evt){var a=args.copy();evt=evt||window.event;a.insert(0,evt);try{callback.apply(window,a.values())}catch(e){print(e)}evt.stopPropagation()}evt.dom.hooked.set(callback,cb);if(isinstance(node,String)){node=$(node)}if(node.addEventListener){node.addEventListener(name,cb,false)}else{node.attachEvent("on"+name,cb)}},unhook:function(node,name,callback){if(isinstance(node,String)){node=$(node)}var cb=evt.dom.hooked.get(callback,null);if(cb){evt.dom.hooked.delete_(callback);if(node.removeEventListener){node.removeEventListener(name,callback,false)}else{node.detachEvent("on"+name,callback)}}}}});nuage.create_class({__module__:"evt",__name__:"Evt",__impl__:{__init__:function(self){self.enabled=true;self._hooks=dict()},hook:function(self,name,callback,data__){var data=list();for(var i=3,l=len(arguments);i<l;i++){data.append(arguments[i])}var l=self._hooks.get(name,null);if(l==null){l=list()}l.append([callback,data]);self._hooks.set(name,l)},unhook:function(self,name,callback){callbacks=self._hooks.get(name,null);if(callbacks!=null){for(var i=0;i<len(callbacks);i++){if(callbacks.get(i)[0]==callback){callbacks.delete_(callback)}}}},emit:function(self,name,args__){if(self.enabled){callbacks=self._hooks.get(name,null);if(callbacks!=null){for(var i=0,l=len(callbacks);i<l;i++){var callback=callbacks.get(i);var args=list();for(var j=2,l2=len(arguments);j<l2;j++){args.append(arguments[j])}args=args.extend(callback[1]);callback[0].apply(window,args.values())}}}}}});nuage.create_module({__name__:"db",__impl__:{datastore:"/",format:"json",_ms:dict(),_ds:dict(),create_db:function(name){var ds=db._ds.get(name,null);if(!ds){ds=dict();db._ds.set(name,ds)}return ds},_serializers:dict(),get_serializer:function(format){var rv=db._serializers.get(format,null);if(rv==null){rv=db[format.upper()+"Serializer"]();db._serializers.set(format,rv)}return rv},_connector:null,get_connector:function(){if(db._connector==null){db._connector=db.RestConnector()}return db._connector},register_model:function(class_){db.create_db(class_.__db__);var ms=db._ms.get(class_.__db__,null);if(!ms){ms=dict()}ms.set(class_.__table__,class_);db._ms.set(class_.__db__,ms)},get_model:function(schema,name){return db._ms.get(schema,dict()).get(name)},find_by_id:function(class_,object_id){return db.find_one(class_,{object_id:object_id})},find_one:function(class_,filter){var rv=db.find(class_,filter,1);if(len(rv)){return rv.pop(0)}else{return null}},find:function(model,filter,limit){var rv=db.Request(model,filter,limit);return rv.get_result()},get:function(class_,key,ref){function register(result){db.set(result);return result}return db.get_connector().get(class_,key,ref).add_callback(register)},list:function(class_,ref,filter){return db.get_connector().list(class_,ref,filter)},set:function(instance){var class_=instance.__class__;var _ds=db._ds.get(class_.__db__,null);if(!_ds){db.create_db(class_.__db__);_ds=db._ds.get(class_.__db__,null)}var c=_ds.get(class_,null);if(!c){c=dict();_ds.set(class_,c)}c.set(instance.object_id,instance)},setdefault:function(instance){var class_=instance.__class__;var _ds=db._ds.get(class_.__db__,null);if(!_ds){db.create_db(class_.__db__);_ds=db._ds.get(class_.__db__,null)}var c=_ds.get(class_,null);if(!c){c=dict();_ds.set(class_,c)}c.setdefault(instance.object_id,instance)},uncache:function(instance){var class_=instance.__class__;var _ds=db._ds.get(class_.__db__);if(!_ds){return}var c=_ds.get(class_,null);if(!c){return}c.delete_(instance.object_id)},create:function(instance){db.set(instance);return db.get_connector().create(instance)},update:function(instance){db.set(instance);return db.get_connector().update(instance)},delete_:function(instance){db.uncache(instance);return db.get_connector().delete_(instance)}}});nuage.create_module({__name__:"db.error",__impl__:{invalid:"{{name}} is invalid",required:"{{name}} is missing",choices:"{{name}} must be one of ({% for value in choices %}{{value}}{%if not for.last %},{%endif%}{%endfor%})",reg_ex:"{{name}} has an invalid format","int":"{{name}} must be numeric","float":"{{name}} must be float",bool:"{{name}} must be a boolean",min_len:"{{name}} is too short",max_len:"{{name}} is too long",min_size:"{{name}} is too short",max_size:"{{name}} is too long",singleline:"{{name}} is not multiline",regex:"{{name}} has an invalid format"}});nuage.create_class({__module__:"db",__name__:"Request",__impl__:{__init__:function(self,model,filter,limit){self.model=model;self.filter=filter;self.limit=limit},get_instances:function(self){var rv=db._ds.get(self.model.__db__,null);if(rv){rv=rv.get(self.model,null)}return rv},get_result:function(self){var rv=list();var key=null;if(self.limit!=null){if(self.limit<=0){return rv}}if(isinstance(self.filter,String)){key=self.filter}var c=self.get_instances();if(c){if(key){key=c.get(key);if(key){rv.append(key)}}else{self.query_filter(rv,c)}}return rv},match_:function(self,key,model,filter){function match_filter(f,o){try{if(isinstance(f,RegExp)){return f.match(o)}else{return o==f}}catch(e){print("db.Request.match_:",e.message,"\n",json.dumps(f),"\n\n",json.dumps(o));return false}}if(key.index(".")>=0){var s=key.split(".");var o=model;for(var i=0,l=len(s);i<l;i++){try{o=o[s[i]]}catch(e){return false}}return match_filter(filter.get(key),o)}else{return match_filter(filter.get(key),model[key])}},query_filter:function(self,result,collection){var filter=dict(self.filter);key=filter.keys().values();var model=collection.values().values();for(var i in model){var match_=true;for(var j in key){match_=self.match_(key[j],model[i],filter);if(!match_){break}}if(match_){if(self.limit==null){result.append(model[i])}else{if(len(result)<=self.limit){result.append(model[i])}if(len(result)==self.limit){break}}}}}}});nuage.create_class({__module__:"db",__name__:"RestConnector",__impl__:{__init__:function(self){self.root=db.datastore;self.format=db.format},_construct:function(self,model_,data,default_){try{if(data.object_id){data.object_id=data.object_id["$oid"]}for(var f in model_.__fields__){if(isinstance(model_.__fields__[f],db.Ref)){var field=model_.__fields__[f];if(data[f]&&!isinstance(data[f],field.ref)){var refi=self._construct(field.ref,data[f],true);if(refi){data[f]=refi}else{print("error construct "+f,"\n",refi,json.dumps(data[f]))}}}}try{var rv=model_(data);if(default_){db.setdefault(rv)}else{db.set(rv)}var ref=db.find(schema.Field,{reference:model_});for(var i=0,l=len(ref);i<l;i++){if(data[ref.get(i).ref.name+"_list"]){var mn=ref.get(i).ref.name;var kl=mn+"_list";for(var k in data[kl]){data[kl][k][mn][ref.get(i)["ref"].split(".")[0]]=rv;var class_=db.get_model("schema",mn);self._construct(class_,data[kl][k][mn],true)}}}return rv}catch(ee){}}catch(e){print(e.message)}},_load_schema:function(self,data){if(data.object_id){data.object_id=data.object_id["$oid"]}var s=schema.Schema(data);for(var m in data.model_list){var md=data.model_list[m]["model"];if(md.object_id){md.object_id=md.object_id["$oid"]}md.schema=s;var model=schema.Model(md);for(var f in md.field_list){var fd=md.field_list[f]["field"];if(fd.object_id){fd.object_id=fd.object_id["$oid"]}fd.model=model;if(fd.reference){id=fd.reference["object_id"]["$oid"];fd.reference=db.find_by_id(schema.Model,id)}var field=schema.Field(fd)}}return s},get:function(self,model,key,ref){function _parse(result){var o=json.load(result.responseText.replace(/"_id"/g,'"object_id"'));if(ref){for(var f in model.__fields__){if(isinstance(model.__fields__[f],db.Ref)&&model.__fields__[f].key){var ref_key=f;o[model.__table__][ref_key]=ref;break}}}if(model==schema.Schema){rv=self._load_schema(o[model.__table__])}else{rv=self._construct(model,o[model.__table__],false)}return rv}var f=defer.HTTPClientFactory();var m=self.root+model.__db__+"/"+model.__table__;if(ref){var m=self.rest_url(ref)+"/"+model.__table__}else{var m=self.root+model.__db__+"/"+model.__table__}reactor.connect_http({url:m+"/"+key+"."+self.format,method:"get"},f);return f.defer.add_callback(_parse)},list:function(self,model,ref,filter){function _parse(result){result=json.load(result.responseText.replace(/"_id"/g,'"object_id"'));var rv=list();if(ref){for(var f in model.__fields__){if(isinstance(model.__fields__[f],db.Ref)&&model.__fields__[f].key){var ref_key=f;break}}}for(var i in result){var data=result[i][model.__table__];try{if(ref){data[ref_key]=ref}var m=self._construct(model,data,false);rv.append(m)}catch(e){print(e)}}return rv}if(ref){var m=self.rest_url(ref)+"/"+model.__table__}else{var m=self.root+model.__db__+"/"+model.__table__}var f=defer.HTTPClientFactory();reactor.connect_http({url:m+"."+self.format,method:"get"},f);return f.defer.add_callback(_parse,ref).add_errback(function(failure){print(failure.get_errormessage())})},rest_url:function(self,model){function impl(m,parent){var key=m.__key__();if(isinstance(key,list)){var ref="";var lkey=list();var k=key.values();var keyname=m.__keyname__().values();var rv=list();for(var i=0,l=len(key);i<l;i++){if(isinstance(k[i],db.Model)){rv.append("/".join(impl(k[i],true)))}else{lkey.append(k[i])}}if(len(ref)){rv.append(ref)}if(parent){rv.append(m.__class__.__table__)}rv.append(",".join(lkey));return rv}else{var rv=list();rv.append(m.__class__.__table__);rv.append(key);return rv}}return self.root+model.__class__.__db__+"/"+"/".join(impl(model,true))},drop_ref:function(self,model){var key=model.__key__();if(isinstance(key,list)){var keyname=model.__keyname__().values();for(var i=0,l=len(key);i<l;i++){if(isinstance(key.get(i),db.Model)){var field=keyname[i];delete model[field]}}}return model},create:function(self,model){model.validate();var url=self.rest_url(model)+"."+self.format;self.drop_ref(model);var data=db.get_serializer(self.format).serialize(model);var f=defer.HTTPClientFactory();reactor.connect_http({url:url,method:"post",postdata:data,headers:{"Content-type":"text/"+self.format+"; charset=utf-8"}},f);return f.defer.add_callback(function(){db.uncache(model)})},update:function(self,model){var data=db.get_serializer(self.format).serialize(model);var f=defer.HTTPClientFactory();var url=self.rest_url(model)+"."+self.format;reactor.connect_http({url:url,method:"put",postdata:data,headers:{"Content-type":"text/"+self.format+"; charset=utf-8"}},f);return f.defer},delete_:function(self,model){var f=defer.HTTPClientFactory();var url=self.rest_url(model)+"."+self.format;var key=model.__key__();reactor.connect_http({url:url,method:"delete"},f);return f.defer}}});nuage.create_class({__module__:"db",__parent__:exc.Exception,__name__:"ConstraintError",__impl__:{__init__:function(self,message){print("ConstraintError:",message);exc.Exception.__init__(self,message)}}});nuage.create_class({__module__:"db",__parent__:exc.Exception,__name__:"ConstraintErrorlist",__impl__:{__init__:function(){self.errors=list()},append:function(self,error){self.errors.append(error)},check:function(self){if(len(self.errors)){throw self}}}});nuage.create_class({__module__:"db.constraint",__name__:"Constraint",__impl__:{__init__:function(self,key){self.key=key||"invalid"},raise:function(self,field,key){key=key||self.key||"invalid";throw db.ConstraintError(self.compile_error(field,key))},compile_error:function(self,field,key,context){var tpl=nuage.Template(db.error[key]||db.error.invalid);return tpl.render(nuage.Context(Object.extend({name:field.name},context||{})))}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Required",__impl__:{__init__:function(self,key){self.key=key||"required"},check:function(self,field,value){if(field.empty(value)){self.raise(field)}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Choices",__impl__:{__init__:function(self,key){self.key=key||"choices"},check:function(self,field,value){if(!field.empty(value)){if(field.choices.index(value)<0){self.raise(field)}}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Int",__impl__:{__init__:function(self,key){self.key=key||"int"},check:function(self,field,value){if(!field.empty(value)){try{value=parseInt(value,10)}catch(e){self.raise(field)}if(value>field.min){self.raise(field,"min")}if(value>field.max){self.raise(field,"max")}}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Float",__impl__:{__init__:function(self,key){self.key=key||"float"},check:function(self,field,value){if(!field.empty(value)){try{value=parseFloat(value,10)}catch(e){self.raise(field)}if(value>field.min){self.raise(field,"min")}if(value>field.max){self.raise(field,"max")}}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Str",__impl__:{__init__:function(self,key){self.key=key||"invalid"},check:function(self,field,value){if(!field.empty(value)){value=str(value);if(field.strip){value=value.strip()}if(len(value)<field.min_len){self.raise(field,"min_len")}if(len(value)>field.max_len){self.raise(field,"max_len")}if(!field.multiline&&(value.index("\n")>=0)){self.raise(field)}}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"Bool",__impl__:{__init__:function(self,key){self.key=key||"bool"},check:function(self,value){if(!field.empty(value)){if(isinstance(value,Boolean)){return value}value=str(value);if(!(/^(true|false|0|1|yes|no)+$/gi).match(value)){self.raise(field)}value=((list("T","1","Y")).index(value.cut(1).upper())>=0)}return value}}});nuage.create_class({__module__:"db.constraint",__parent__:db.constraint.Constraint,__name__:"RegEx",__impl__:{__init__:function(self,regex,key){self.key=key||"regex";self.regex=regex},check:function(self,field,value){if(!field.empty(value)){if(!regex.match(value)){self.raise(field)}}return value}}});nuage.create_class({__module__:"db",__name__:"Field",__impl__:{__init__:function(self,options){self.key=false;self.default_=null;self.required=false;self.choices=null;self._constraints=[];Object.extend(self,options||{});if(self.key){self.required=true}if(self.required){self._constraints.push(db.constraint.Required(self))}if(self.choices!=null){self._constraints.push(db.constraint.Choices(self))}},set:function(self,value){return self.validate(value)},empty:function(self,value){if(value==null){return true}return(len(value)==0)},validate:function(self,value){for(var i=0,l=len(self._constraints);i<l;i++){value=self._constraints[i].check(self,value)}return value}}});nuage.create_class({__module__:"db",__parent__:db.Field,__name__:"Str",__impl__:{__init__:function(self,options){var options=Object.extend({multiline:false,strip:true,min_len:0,max_len:8000,reg_ex:null,constraints:[db.constraint.Str()]},options||{});db.Field.__init__(self,options);if(options.reg_ex){constraints.push(db.constraint.RegEx(option.reg_ex))}}}});nuage.create_class({__module__:"db",__parent__:db.Field,__name__:"Int",__impl__:{__init__:function(self,options){var options=Object.extend({multiline:false,min_value:-2147483648,max_value:2147483647},options||{});db.Field.__init__(self,options)}}});nuage.create_class({__module__:"db",__parent__:db.Field,__name__:"Bool",__impl__:{__init__:function(self,options){var options=Object.extend({constraints:[db.constraint.Bool()]},options||{});db.Field.__init__(self,options)}}});nuage.create_class({__module__:"db",__parent__:db.Str,__name__:"ObjectId",__impl__:{__init__:function(self,options){options=Object.extend({key:true},options);options.default_=function(){var rv="_js";var str="abcdefghijklmnopqrstuvwxyz0123456789";for(var i in range(22)){rv+=str[rand(36)]}return rv};db.Field.__init__(self,options)}}});nuage.create_class({__module__:"db",__parent__:db.Str,__name__:"Password"});nuage.create_class({__module__:"db",__parent__:db.Field,__name__:"DateTime",__impl__:{__init__:function(self,opt){if(opt.now){opt.default_=function(){return datetime.now()}}db.Field.__init__(self,opt)},set:function(self,value){if(isinstance(value,String)){var v=re.compile("([0-9]{4})-([0-9]{2})-([0-9]{2})(\\s|T)?([0-9]{2})?:?([0-9]{2})?:?([0-9]{2})?.?([0-9]{3})?","g");var m=v.search(value);if(m!=null){value=datetime(int_(m[1]||0),int_(m[2]||0),int_(m[3]||0),int_(m[5]||0),int_(m[6]||0),int_(m[7]||0),int_(m[8]||0))}else{value=datetime(value)}}return db.Field.validate(self,value)}}});nuage.create_class({__module__:"db",__name__:"Ref",__parent__:db.Field,__impl__:{__init__:function(self,opt){self.ref=opt.ref;db.Field.__init__(self,opt)}}});nuage.create_class({__module__:"db",__name__:"Model",__static__:{__db__:"default",__table__:null},__impl__:{__init__:function(self,values){self._evt=evt.Evt();self._key=list();var fields=self.__class__.__fields__;for(var k in fields){var field=fields[k];field.name=k;if(field.key){self._key.append(field)}if(values[k]!=null){if(isinstance(fields[k],db.Ref)){if(isinstance(values[k],fields[k].ref)){self.set(k,values[k])}else{self.set(k,fields[k].ref(values[k]))}}else{self.set(k,values[k])}}else{var d=field.default_;if(callable(d)){self.set(k,d())}else{self.set(k,d)}}}if(len(self._key)<1){var _id=db.ObjectId();_id.name="object_id";self.__class__.__fields__.object_id=_id;if(values.object_id){self.set("object_id",values.object_id)}else{self.set("object_id",_id.default_())}self._key.append(self.__class__.__fields__.object_id)}else{var _id=db.ObjectId({key:false});_id.name="object_id";self.__class__.__fields__.object_id=_id;if(values.object_id){self.set("object_id",values.object_id)}else{self.set("object_id",_id.default_())}}if(len(self._key)==1){self._key=self._key.get(0)}db.set(self)},set:function(self,name,value){var k=dict(self.__class__.__fields__).keys();if(k.index(name)>=0){self._evt.emit("field-changing",name,value);self[name]=self.__class__.__fields__[name].set(value)}else{throw exc.AttributeError()}self._evt.emit("field-changed",name,self[name])},__key__:function(self,with_ref){if(arguments.length==1){with_ref=true}if(isinstance(self._key,list)){var rv=list();var k=self._key.values();for(i in k){if(with_ref||(!with_ref&&!isinstance(self[k[i].name],db.Model))){rv.append(self[k[i].name])}}if(!with_ref){if(len(rv)==1){rv=rv.get(0)}}return rv}else{return self[self._key.name]}},__keyname__:function(self){if(isinstance(self._key,list)){var rv=list();var k=self._key.values();for(i in k){rv.append(k[i].name)}return rv}else{return self._key.name}},validate:function(self){var e=db.ConstraintErrorlist();var fields=self.__class__.__fields__;for(var k in fields){var field=fields[k];try{self.set(k,self[k])}catch(exc){if(isintance(exc,db.ConstraintError)){e.append(exc)}else{throw exc}}}}}});nuage.create_class({__module__:"db",__name__:"JSONSerializer",__impl__:{serialize:function(self,model,serialization_info){m={};m[model.__class__.__table__]=model;return self.dumps(m)},dumps:function(self,model,done){if(arguments.length==3){if(done.index(model)>=0){if(model.object_id){return'{"_id":{"$oid":"'+model.object_id+'"}}'}else{return"{}"}}}else{done=list()}done.append(model);if(isinstance(model,list)){model=model._values}if(isinstance(model,dict)){model=str(model)}var obj_=!(model instanceof Array);var rvlist=list();var s="";for(var p in model){if(model[p]==null){continue}if(p.cut(1)=="_"){continue}s="";var type=typeof(model[p]);switch(type){case"object":if(model[p] instanceof Date){if(obj_){s+='"'+p+'":"'}s+=model[p].getFullYear()+"-";s+=str(model[p].getMonth()+1).zfill(2)+"-";s+=str(model[p].getDay()).zfill(2)+"T";s+=str(model[p].getHours()).zfill(2)+":";s+=str(model[p].getMinutes()).zfill(2)+":";s+=str(model[p].getSeconds()).zfill(2)+".";s+=str(model[p].getMilliseconds()).zfill(3)+'"'}else{if(obj_){s+='"'+p+'":'}if(isinstance(model[p],datetime)){s+='"'+model[p].isoformat()+'"'}else{s+=self.dumps(model[p],done)}}break;case"function":break;case"boolean":case"number":if(obj_){s+='"'+p+'":'}s+=model[p];break;default:if(p=="object_id"){if(model[p].cut(1)!="_"){if(obj_){s+='"_id":{"$oid":'}s+='"'+model[p]+'"}'}}else{if(model[p]){if(obj_){s+='"'+p+'":'}s+='"'+model[p]+'"'}}break}if(len(s)){rvlist.append(s)}}if(obj_){rv="{"+",".join(rvlist)+"}"}else{rv="["+",".join(rvlist)+"]"}return rv}}});nuage.create_module({__name__:"route",__impl__:{_views:dict(),_maps:list(),register:function(name,view){route._views.set(name,view)},connect:function(routepath,defaults_){route._maps.append(route.Route(routepath,defaults_))},render:function(data){try{var maps=route._maps;for(var i=0,l=len(maps);i<l;i++){var c=maps.get(i);if(c.rev_match(data)){var hash=str(c.routepath);hash=hash.replace(re.compile(":[^}]+}","g"),"}");var k=data.keys().values();for(var i=0,l=len(k);i<l;i++){try{hash=hash.replace(re.compile("{"+k[i]+"}","g"),data.get(k[i]))}catch(exc){print("--- "+json.dumps(exc))}}return"#"+hash}}}catch(e){print("error building route:",e.message);return"#"}},redirect:function(data){window.location=route.render(data)},parse_hash:function(hash){hash=hash||window.location.hash;var m;var maps=route._maps;for(var i=0,l=len(maps);i<l;i++){var croute=maps.get(i);m=croute.match(hash);if(m){return m}}return null},dispatch:function(hash){var m=route.parse_hash(hash);print("dispaching route "+hash);if(m){route._views.get(m.get("view"))["do_"+m.get("action")](m)}else{print("no route found")}}}});nuage.create_class({__module__:"route",__name__:"Route",__impl__:{__init__:function(self,routepath,defaults_){self.routepath=routepath;var path_re="^#?";var routelist=dict();var r=routepath.split(/\{|\}/g);var intag=false;var pos=1;for(var i in r){if(intag){var s=r[i].split(":");if(len(s)>1){path_re+="("+s[1]+")"}else{path_re+="([a-z0-9_\\-]*)"}routelist.set(s[0],pos);pos++}else{path_re+=r[i]}intag=!intag}self.defaults_=defaults_;self.path_re=path_re+"$";self.routelist=routelist},match:function(self,hash){var path_re=re.compile(self.path_re,"gi");var r=path_re.search(hash);if(!r){return false}var v=self.routelist.keys().values();var rv=dict();rv.update(self.defaults_);for(var i in v){rv.set(v[i],r[self.routelist.get(v[i])])}return rv},rev_match:function(self,m){var k1=m.keys().copy().values();k1.sort();var k2=self.routelist.keys().copy().values();k2.sort();return",".join(k1)==",".join(k2)}}});nuage.create_class({__module__:"defer",__name__:"AlreadyCalled",__parent__:exc.ValueError});nuage.create_class({__module__:"defer",__name__:"AlreadyCancelled",__parent__:exc.ValueError});nuage.create_class({__module__:"defer",__name__:"TimeoutError",__parent__:exc.ValueError});nuage.create_class({__module__:"defer",__name__:"ServerError",__parent__:exc.Exception,__impl__:{__init__:function(self,transport){exc.Exception.__init__(self,"{0}\n{1}".format(transport.status,transport.responseText));self.transport=transport},__str__:function(self){return self.message}}});defer.passthru=function(arg){return arg};defer.succeed=function(result){var d=defer.Deferred();d.callback(result);return d};defer.fail=function(failure){var d=defer.Deferred();d.errback(failure);return d};defer.maybe=function(f,args){try{result=f.apply(window,args)}catch(e){return defer.fail(defer.Failure(e))}if(isinstance(result,defer.Deferred)){return result}else{if(isinstance(result,defer.Failure)){return defer.fail(result)}else{print(result);return defer.succeed(result)}}};nuage.create_class({__module__:"defer",__name__:"Failure",__impl__:{__init__:function(self,exc_value,exc_type){self.value=exc_value;if(exc_type){self.type=exc_type}else{self.type=exc_value.__class__}},get_error_message:function(self){return self.value.message},raiseException:function(self){throw self.value},check:function(self,args__){print("todo")},trap:function(self,args__){print("todo")}}});nuage.create_class({__module__:"defer",__name__:"Deferred",__impl__:{__init__:function(self){self.callbacks=list();self.called=false;self._running_cb=false;self.result=null;self.paused=0},add_callbacks:function(self,callback,errback,cbargs,ebargs){params={callback:callback||defer.passthru,cbargs:cbargs||list(),errback:errback||defer.passthru,ebargs:ebargs||list()};self.callbacks.append(params);if(self.called){self._run_cb(params)}return self},_build_params:function(self,func,args__){var rv={func:null,args:[]};rv.func=func;var args=list(arguments);args.pop(0);rv.args=args;return rv},add_callback:function(self,callback,args__){var args=list();for(var i=2,len=arguments.length;i<len;i++){args.append(arguments[i])}return self.add_callbacks(callback,null,args)},add_errback:function(self,errback,args__){var args=list();for(var i=2,len=arguments.length;i<len;i++){args.append(arguments[i])}return self.add_callbacks(null,errback,null,args)},add_both:function(self,callback,args__){var args=list();for(var i=2,len=arguments.length;i<len;i++){args.append(arguments[i])}return self.add_callbacks(callback,callback,args,args)},callback:function(self,result){self._start_run_cb(result)},errback:function(self,fail){self._start_run_cb(fail)},pause:function(self){self.paused=self.paused+1},unpause:function(self){self.paused=self.paused-1;if(self.paused){return}if(self.called){self._run_cb()}},_continue:function(self,result){self.result=result;self.unpause()},_start_run_cb:function(self,result){if(self.called){throw defer.AlreadyCalled()}self.called=true;self.result=result;self._run_cb()},_run_cb:function(self){if(self._running_cb){return}if(self.paused==0){while(len(self.callbacks)>0){var item=self.callbacks.pop(0);if(isinstance(self.result,defer.Failure)){callback=item.errback;args=item.ebargs}else{callback=item.callback;args=item.cbargs}args.insert(0,self.result);try{self._running_cb=true;try{self.result=callback.apply(window,args.values())}catch(exc){self.result=defer.Failure(exc)}finally{self._running_cb=false}if(isinstance(self.result,defer.Deferred)){self.pause();self.result.add_both(self._continue);break}}catch(exc){self.result=defer.Failure(exc)}}}}}});nuage.create_class({__module__:"defer",__name__:"DeferredList",__parent__:defer.Deferred,__impl__:{__init__:function(self,deferred_list,options){defer.Deferred.__init__(self);var options=Object.extend({fire_one_callback:false,fire_one_errback:false,consume_errors:false},options);self.fire_one_cb=options.fire_one_callback;self.fire_one_eb=options.fire_one_errback;self.consume_errors=options.consume_errors;self.result_list=list();self.finished_cnt=0;for(var i=0,l=len(deferred_list);i<l;i++){self.result_list.append(null)}for(var i=0,l=len(self.result_list);i<l;i++){deferred_list.get(i).add_callbacks(self._cb,self._cb,list([i,true]),list([i,false]))}},_cb:function(self,result,index,succeeded){self.finished_cnt++;self.result_list.set(index,result);if(!self.called){if(succeeded&&self.fire_one_cb){self.callback(list(result,index))}else{if(!succeeded&&self.fire_one_eb){self.errback(list(result,index))}else{if(self.finished_cnt==len(self.result_list)){self.callback(self.result_list)}}}if(!succeeded&&self.consume_errors){result=null}}return result}}});nuage.create_class({__module__:"defer",__name__:"Protocol",__impl__:{__init__:function(self){self.factory=null},make_connection:function(self,fransport){},connection_made:function(self){},connection_lost:function(self,failure){}}});nuage.create_class({__module__:"defer",__name__:"HttpRequest",__parent__:defer.Protocol,__impl__:{__init__:function(self,context){var default_context={url:null,method:"get",postdata:null,headers:{"Content-type":"text/plain; charset=utf-8",connection:"close",agent:"nuage"},cookies:{}};Object.extend(default_context.headers,context.headers);Object.extend(default_context.cookies,context.cookies);context=Object.extend(default_context,context);if(context.postdata&&!context.headers){context.headers["content-length"]=len(postdata)}Object.extend(self,context)},make_connection:function(self,transport){transport.open(self.method,self.url,true)},connection_made:function(self,transport){for(var k in self.headers){transport.setRequestHeader(k,self.headers[k])}if(self.method=="post"||self.method=="put"){transport.send(self.postdata)}else{transport.send(null)}}}});nuage.create_class({__module__:"defer",__name__:"ClientFactory",__impl__:{__init__:function(self){self.protocol=null},build_protocol:function(self,context){var rv=self.protocol(context);rv.factory=self;return rv},started_connecting:function(self,connector){},client_connection_failed:function(self,connector,failure){},client_connection_lost:function(self,connector,failure){}}});nuage.create_class({__module__:"defer",__name__:"HTTPClientFactory",__parent__:defer.ClientFactory,__impl__:{__init__:function(self){self.waiting=false;self.defer=defer.Deferred();self.protocol=defer.HttpRequest},build_protocol:function(self,context){var p=defer.ClientFactory.build_protocol(self,context);if(context.timeout){var tc=reactor.call_later(context.timeout,self,self._timeout);self.defer.add_both(self,self._cancel_timeout,tc)}return p},started_connecting:function(self,connector){var t=connector.transport;self.transport=t;var p=connector.build_protocol();self.waiting=true;try{p.make_connection(t)}catch(exc){self.client_connection_failed(defer.Failure(exc))}if(self.waiting){t.onreadystatechange=function(){if(t.readyState==4){if(t.status<400){self.page(t)}else{self.no_page(defer.Failure(defer.ServerError(t)))}}};p.connection_made(t)}},_timeout:function(self,result){self.waiting=false;self.transport.abort();self.no_page(defer.Failure(TimeoutError()))},_cancel_timeout:function(self,result,timeout_call){if(timeout_call.active()){timeout_call.cancel()}return result},page:function(self,result){if(self.waiting){self.waiting=false;self.defer.callback(result)}},no_page:function(self,failure){if(self.waiting){self.waiting=false;self.defer.errback(failure)}},client_connection_failed:function(self,failure){if(self.waiting){self.waiting=false;self.defer.errback(failure)}}}});nuage.create_class({__module__:"defer",__name__:"HttpConnector",__impl__:{__init__:function(self,context,factory,reactor){self.state="disconnected";self.transport=null;self.context=context;self.factory=factory;self.reactor=reactor},connect:function(self){self.transport=self._make_transport();self.factory.started_connecting(self)},build_protocol:function(self){return self.factory.build_protocol(self.context)},_make_transport:function(self){try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}return new XMLHttpRequest()}}});nuage.create_class({__module__:"defer",__name__:"DelayedCall",__static__:{__lt__:function(self,a,b){return(a.time<b.time)},__gt__:function(self,a,b){return(a.time>b.time)}},__impl__:{__init__:function(self,time,func,args){self.time=time;self.func=func;self.args=args||[];self.cancelled=false;self.called=false},cancel:function(self){if(self.cancelled){throw defer.AlreadyCancelled()}if(self.called){throw defer.AlreadyCalled()}self.cancelled=true;self.object=null;self.func=null},active:function(self){return !(self.cancelled||self.called)}}});nuage.create_class({__module__:"defer",__name__:"Reactor",__impl__:{__init__:function(self){self._started=false;self._pending_dc=list();self._new_dc=list()},seconds:function(self){var d=new Date();d.setMilliseconds(0);return d.getTime()/1000},_insert_new_dc:function(self){while(len(self._new_dc)>0){o=self._new_dc.pop(0);if(!o.cancelled){self._pending_dc.append(o)}}self._pending_dc.sort()},run_until_current:function(self){self._insert_new_dc();var now=self.seconds();while(len(self._pending_dc)&&self._pending_dc.get(0).time<=now){var dc=self._pending_dc.pop(0);if(!dc.cancelled){dc.called=true;window.setTimeout(function(){dc.func.apply(window,dc.args)},0)}}},run:function(self){self._started=true;evt.dom.hook(window,"load",function(){evt.dom.hook(window,"hashchange",self.on_hashchanged);try{route.dispatch()}catch(e){route.redirect(dict())}});evt.dom.hook(window,"unload",self.stop);self.main_loop()},on_hashchanged:function(self,evt){route.dispatch()},main_loop:function(self){if(self._started){self.run_until_current();window.setTimeout(function(){self.main_loop()},1000)}},stop:function(self){self._started=false},call_later:function(self,second,func,args__){var args=[];for(var i=3,l=arguments.length;i<l;i++){args.push(arguments[i])}var rv=defer.DelayedCall((self.seconds()+second),func,args);self._new_dc.append(rv);return rv},connect_http:function(self,context,factory){if(!factory){factory=defer.HTTPClientFactory()}var c=defer.HttpConnector(context,factory,self);c.connect();return c},connect_websocket:function(self,contect,factory){throw Exception("Unimplemented feature")}}});window.reactor=defer.Reactor();nuage.create_class({__name__:"View",__module__:"nuage",__impl__:{__init__:function(){},dispatch:function(self,data){var method="do_"+data.get("action");if(hasattr(self,method)){f=getattr(self,method);f(data)}else{throw exc.Exception("View action's not implemented: "+method)}}}});nuage.create_module({__name__:"nuage.tpl",__impl__:{TEMPLATE_DIRS:"/templates/",BLOCK_TAG_START:"{%",BLOCK_TAG_END:"%}",VAR_TAG_START:"{{",VAR_TAG_END:"}}",VAR_ATTR_SEP:".",COMMENT_TAG_START:"{#",COMMENT_TAG_END:"#}",tag_re:/(\{%[^%]*%\}|\{\{[^\}]*\}\}|\{#[^#]*#\})/gim,BLOCK_CONTEXT_KEY:"block_context",TOKEN_TEXT:0,TOKEN_VAR:1,TOKEN_BLOCK:2,TOKEN_COMMENT:3,FILTER_SEP:"|",FILTER_ARG_SEP:":",filter_re:/([a-z][^\|]*)+(\|(([a-z][^\|\:]*)?(:"?\s*"?)?)+)*/ig,smart_split_re:/[^\s"]*("[^"\\]*(\\.[^"\\]*)*")\S*|[^\s']*('[^'\\]*(\\.[^'\\]*)*')\S*|(\S+)/gim,compile_string:function(str){lexer=nuage.tpl.Lexer(str);parser=nuage.tpl.Parser(lexer.tokenize());return parser.parse()},smart_split:function(str){var rv=list();var m;var splitting;var str2;str=str.strip();do{m=this.smart_split_re.search(str);splitting=m!=null;if(splitting){str2=m[5]||m[1]||m[3];rv.append(str2)}}while(splitting);return rv},mark_safe:function(str){return nuage.tpl.SafeString(str)},escape:function(str_){if(!isinstance(str_,String)){str_=str(str_)}return nuage.tpl.mark_safe(str_.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;").replace("'","&#39;"))},templates:dict(),get_template:function(name,headers){var t=nuage.tpl.templates.get(name,null);if(t){return defer.succeed(t)}var t=document.getElementById(name);if(t){var tpl=nuage.tpl.Template(t.text,name);nuage.tpl.templates.set(name,tpl);t.parentNode.removeChild(t);return defer.succeed(tpl)}function _parse(result){var tpl=nuage.tpl.Template(result.responseText,name);nuage.tpl.templates.set(name,tpl);return tpl}function _err(err){throw nuage.tpl.TemplateDoesNotExist(name)}var f=defer.HTTPClientFactory();var ctx={url:nuage.tpl.TEMPLATE_DIRS+name,method:"get"};if(headers){ctx.headers=headers}reactor.connect_http(ctx,f);return f.defer.add_both(_parse,_err)},helpers:{route_url:function(view,kw){kw.view=view;return route.render(dict(kw))},"super":function(context){return context.get("block").super_()}},filters:{capitalize:function(s){return s.capitalize()},length:function(o){return len(o)},safe:function(s){return nuage.tpl.mark_safe(str(s))},escape:function(s){return nuage.tpl.EscapeString(str(s))}},tags:{"if":function(parser,token){var bits=token.split_contents();bits.pop(0);var var_=nuage.tpl.TemplateIfParser(parser,bits).parse();var nodelist_true=parser.parse(list("else","endif"));var token=parser.next_token();if(token.contents=="else"){var nodelist_false=parser.parse(list("endif"));parser.delete_first_token()}else{var nodelist_false=nuage.tpl.NodeList()}return nuage.tpl.IfNode(var_,nodelist_true,nodelist_false)},"for":function(parser,token){var bits=list(token.contents.split());if(len(bits)<4){throw nuage.tpl.TemplateSyntaxError("'for' statements should have at least four words: {0}".format(token.contents))}var is_reversed=bits.get(-1)=="reversed";var in_index=is_reversed&&-3||-2;if(bits.get(in_index)!="in"){throw nuage.tpl.TemplateSyntaxError("'for' statements should use the format 'for x in y': {0}".format(token.contents))}var loopvars=bits.get(1,in_index).split(",");for(var i=0,len_=len(loopvars);i<len_;i++){loopvars[i]=loopvars[i].strip();var var_=loopvars[i];if(!var_||(var_.index(" ")>=0)){throw nuage.tpl.TemplateSyntaxError("'for' tag received an invalid argument: {0}".format(token.contents))}}var sequence=parser.compile_filter(bits.get(in_index+1));var nodelist_loop=parser.parse(list("empty","endfor"));var token=parser.next_token();if(token.contents=="empty"){var nodelist_empty=parser.parse(list("endfor"));parser.delete_first_token()}else{var nodelist_empty=null}return nuage.tpl.ForNode(loopvars,sequence,is_reversed,nodelist_loop,nodelist_empty)},block:function(parser,token){var bits=token.contents.split();if(len(bits)!=2){throw nuage.tpl.TemplateSyntaxError("'{0}' tag takes only one argument".format(bits[0]))}var block_name=bits[1];try{if(parser.loaded_tags.index(block_name)>=0){throw nuage.tpl.TemplateSyntaxError("'{0}' tag with name '{1}' appears "+"more than once".format(bits[0],block_name))}parser.loaded_tags.append(block_name)}catch(e){throw e}var nodelist=parser.parse(list("endblock","endblock "+block_name));parser.delete_first_token();return nuage.tpl.BlockNode(block_name,nodelist)},"extends":function(parser,token){var bits=token.split_contents();if(len(bits)!=2){throw nuage.tpl.TemplateSyntaxError("'{0}' takes one argument".format(bits[0]))}var parent_name=null;var parent_name_expr=null;var path=bits.get(1);if((list('"',"'")).index(path.cut(0,1)>=0)&&(path.cut(-1)==path.cut(0,1))){parent_name=path.cut(1,-1)}else{parent_name_expr=parser.compile_filter(bits[1])}var nodelist=parser.parse();if(len(nodelist.get_nodes_by_type(nuage.tpl.ExtendsNode))>0){throw nuage.tpl.TemplateSyntaxError("'{0}' cannot appear more than once in the same template".format(bits[0]))}return nuage.tpl.ExtendsNode(nodelist,parent_name,parent_name_expr)},include:function(parser,token){var bits=token.split_contents();if(len(bits)!=2){throw nuage.tpl.TemplateSyntaxError("{0} tag takes one argument: the name of the template to be included".format(bits[0]))}var path=bits.get(1);if((list('"',"'")).index(path.cut(0,1)>=0)&&(path.cut(-1)==path.cut(0,1))){return nuage.tpl.ConstantIncludeNode(path.cut(1,-1))}return nuage.tpl.IncludeNode(bits.get(1))}}}});nuage.create_class({__module__:"nuage.tpl",__name__:"TemplateDoesNotExist",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"TemplateNotFound",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"TemplateSyntaxError",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"SafeData"});nuage.create_class({__module__:"nuage.tpl",__name__:"SafeString",__parent__:[nuage.tpl.SafeData,String],});nuage.create_class({__module__:"nuage.tpl",__name__:"EscapeData"});nuage.create_class({__module__:"nuage.tpl",__name__:"EscapeString",__parent__:[nuage.tpl.EscapeData,String]});nuage.create_class({__module__:"nuage.tpl",__name__:"Lexer",__impl__:{__init__:function(self,template_string){self.template_string=template_string||""},tokenize:function(self){var rv=list();var in_tag=false;var bits=nuage.tpl.tag_re.split(self.template_string);for(var i=0,length=len(bits);i<length;i++){if(bits[i]){rv.append(self.create_token(bits[i],in_tag))}in_tag=!in_tag}return rv},create_token:function(self,token,in_tag){if(in_tag){if(token.startswith(nuage.tpl.VAR_TAG_START)){return nuage.tpl.Token(nuage.tpl.TOKEN_VAR,token.cut(len(nuage.tpl.VAR_TAG_START),-len(nuage.tpl.VAR_TAG_END)).strip())}if(token.startswith(nuage.tpl.BLOCK_TAG_START)){return nuage.tpl.Token(nuage.tpl.TOKEN_BLOCK,token.cut(len(nuage.tpl.BLOCK_TAG_START),-len(nuage.tpl.BLOCK_TAG_END)).strip())}if(token.startswith(nuage.tpl.COMMENT_TAG_START)){return nuage.tpl.Token(nuage.tpl.TOKEN_COMMENT,"")}}return nuage.tpl.Token(nuage.tpl.TOKEN_TEXT,token)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Parser",__impl__:{__init__:function(self,tokens){self.tokens=tokens||list();self.tags=dict(nuage.tpl.tags);self.filters=dict(nuage.tpl.filters);self.loaded_tags=list()},parse:function(self,parse_until){parse_until=parse_until||list();var nodelist=nuage.tpl.NodeList();while(len(self.tokens)>0){var token=self.next_token();switch(token.token_type){case nuage.tpl.TOKEN_TEXT:self.extend_nodelist(nodelist,nuage.tpl.TextNode(token.contents),token);break;case nuage.tpl.TOKEN_VAR:if(!token.contents){self.empty_variable(token)}var filter_expression=self.compile_filter(token.contents);var var_node=self.create_variable_node(filter_expression);self.extend_nodelist(nodelist,var_node,token);break;case nuage.tpl.TOKEN_BLOCK:if(parse_until.index(token.contents)>=0){self.prepend_token(token);return nodelist}try{var command=token.contents.split()[0]}catch(e){self.empty_block_tag(token)}self.enter_command(command,token);try{compile_func=self.tags.get(command)}catch(e){pprint(e);self.invalid_block_tag(token,command)}try{compiled_result=compile_func(self,token)}catch(e){pprint(e);if(!self.compile_function_error(token,e)){throw e}}self.extend_nodelist(nodelist,compiled_result,token);self.exit_command();break}}return nodelist},skip_past:function(self,endtag){while(len(self.tokens)>0){token=self.next_token();if((token.token_type==TOKEN_BLOCK)&&(token.contents==endtag)){return}}self.unclosed_block_tag(list({values:[endtag]}))},create_variable_node:function(self,filter_expr){return nuage.tpl.VariableNode(filter_expr)},extend_nodelist:function(self,nodelist,node,token){if(node.must_be_first&&(len(nodelist)>0)){throw nuage.tpl.TemplateSyntaxError("{0} must be the first tag in the template.".format(node))}if(isinstance(nodelist,nuage.tpl.NodeList)&&!isinstance(node,nuage.tpl.TextNode)){nodelist.contains_nontext=true}nodelist.append(node)},enter_command:function(self,command,token){},exit_command:function(self,command,token){},error:function(self,token,msg){return nuage.tpl.TemplateSyntaxError(msg)},empty_variable:function(self,token){throw self.error(token,"Empty variable tag")},empty_block_tag:function(self,token){throw self.error(token,"Empty block tag")},invalid_block_tag:function(self,token,command){throw self.error(token,"Invalid block tag '{0}'".format(command))},unclosed_block_tag:function(self,parse_until){throw self.error(null,"Unclosed tags: {0}".format(", ".join(parse_until)))},compile_function_error:function(self,token,e){},next_token:function(self){return self.tokens.pop(0)},prepend_token:function(self,token){self.tokens.insert(0,token)},delete_first_token:function(self){self.tokens.delete_(0,1)},add_library:function(self,lib){self.tags.update(lib.tags);self.filters.update(lib.filters)},compile_filter:function(self,token){return nuage.tpl.FilterExpression(token,self)},find_filter:function(self,filter_name){if(self.filters.keys().index(filter_name)>=0){return self.filters.get(filter_name)}throw self.error(null,"Invalid filter: '{0}'".format(filter_name))}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Template",__impl__:{__init__:function(self,template_str,name){self.template_str=template_str;self.name=name||"<Unknown template>";self.nodelist=nuage.tpl.compile_string(template_str)},get_block:function(self,name){var nl=self.nodelist.get_nodes_by_type(nuage.tpl.BlockNode);for(var i=0,l=len(nl);i<l;i++){if(nl.get(i).name==name){return nl.get(i)}}return null},render:function(self,context){context.render_context.push();try{return self.nodelist.render(context)}catch(e){pprint("template.render exception",e)}finally{context.render_context.pop()}}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Token",__impl__:{__init__:function(self,token_type,contents){self.token_type=token_type;self.contents=contents},split_contents:function(self){return nuage.tpl.smart_split(self.contents)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Variable",__impl__:{__init__:function(self,var_){self.literal=null;self.lookups=null;self.translate=false;try{self.literal=float_(var_)}catch(e){self.var_=var_;if((self.var_.startswith('"')||self.var_.startswith("'"))&&(self.var_.cut(1)==self.var_.cut(-1))){self.literal=nuage.tpl.mark_safe(self.var_.cut(1,-1))}else{self.lookups=self.var_.split(nuage.tpl.VAR_ATTR_SEP)}}},resolve:function(self,context){var value;if(self.lookups!=null){value=self._resolve_lookup(context)}else{value=self.literal}if(self.translate){}return defer.succeed(value)},_resolve_lookup:function(self,context){var current=null;try{current=context;for(var i=0,length=len(self.lookups);i<length;i++){if(isinstance(current,dict)||isinstance(current,nuage.tpl.Context)){current=current.get(self.lookups[i])}else{current=current[self.lookups[i]]}}}catch(e){pprint(e);current=""}if(current==null){current=""}return current}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Helper",__impl__:{__init__:function(self,helper){helper=list(helper);self.helper=helper.get(1);self.helper_args=helper.get(2,null);if(self.helper_args){self.helper_args=self.helper_args.split(",")}else{self.helper_args=[]}},resolve:function(self,context){if(nuage.tpl.helpers[self.helper]){var asynclist=list();var args=[];var kw={};for(var i=0,l=len(self.helper_args);i<l;i++){var arg=self.helper_args[i].strip();if((list('"',"'")).index(arg.cut(0,1)>=0)&&(arg.cut(-1)==arg.cut(0,1))){asynclist.append(defer.succeed(arg.cut(1,-1)).add_callback(function(result){args[i]=result}))}else{if(arg.index("=")>0){var d=arg.split("=");d[0]=d[0].strip();d[1]=d[1].strip();if((list('"',"'")).index(d[1].cut(0,1)>=0)&&(d[1].cut(-1)==d[1].cut(0,1))){asynclist.append(defer.succeed(d[1].cut(1,-1)).add_callback(function(result){kw[d[0]]=result}))}else{var v=nuage.tpl.Variable(d[1]);asynclist.append(v.resolve(context).add_callback(function(result){kw[d[0]]=result}))}}else{var v=nuage.tpl.Variable(arg);asynclist.append(v.resolve(context).add_callback(function(result){args[i]=result}))}}}if(len(asynclist)==0){asynclist.append(defer.succeed(1))}return defer.DeferredList(asynclist).add_callback(function(result){if(len(kw)){args.push(kw)}args.push(context);return nuage.tpl.helpers[self.helper].apply(window,args)})}return defer.succeed("")}}});nuage.create_class({__module__:"nuage.tpl",__name__:"FilterExpression",__impl__:{__init__:function(self,token,parser){self.token=token;self.parser=parser;var helper_re=/([^\(]+)\(([^\)]*)?\)/gim;var g=self.token.split(nuage.tpl.FILTER_SEP);var helper=helper_re.search(g[0]);if(helper){self.var_=nuage.tpl.Helper(helper)}else{self.var_=nuage.tpl.Variable(g[0])}self.filters=list();for(var i=1,length=g.length;i<length;i++){var filter=g[i].split(nuage.tpl.FILTER_ARG_SEP);var filter_func=self.parser.find_filter(filter[0]);var filter_args=list();for(var j=1,len2=filter.length;j<len2;j++){if(filter[j].startswith('"')&&filter[j].endswith('"')){filter_args.append([false,filter[j].cut(1,-1)])}else{filter_args.append(true,filter[j])}}var f=[filter[0],filter_func,filter_args];self.filters.append(f)}},resolve:function(self,context,ignore_failures){return self.var_.resolve(context).add_callback(function(result){for(var i=0,l=len(self.filters);i<l;i++){var f=self.filters.get(i);f[2].insert(0,result);result=f[1].apply(window,f[2].values())}return result}).add_errback(function(err){pprint(err);return""})}}});nuage.create_class({__module__:"nuage.tpl",__name__:"ContextPopException",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"BaseContext",__impl__:{__init__:function(self,dict_,autoescape){dict_=dict(dict_||{});self.dicts=list([dict_])},push:function(self){var rv=dict();self.dicts.append(rv);return rv},pop:function(self){if(len(self.dicts)==1){throw nuage.tpl.ContextPopException()}return self.dicts.pop()},has_key:function(self,key){for(var i=len(self.dicts)-1;i>=0;i--){if(self.dicts.get(i).has_key(key)){return true}}return false},get:function(self,key,default_){for(var i=len(self.dicts)-1;i>=0;i--){if(self.dicts.get(i).has_key(key)){return self.dicts.get(i).get(key)}}return default_},set:function(self,key,value){return self.dicts.get(-1).set(key,value)},delete_:function(self,key){return self.dicts.get(-1).delete_(key)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Context",__parent__:nuage.tpl.BaseContext,__impl__:{__init__:function(self,dict_,autoescape){self.autoescape=autoescape||true;self.render_context=nuage.tpl.RenderContext();nuage.tpl.BaseContext.__init__(self,dict_)},update:function(self,other){var d=self.dicts.get(-1);d.update(other);return self}}});nuage.create_class({__module__:"nuage.tpl",__name__:"RenderContext",__parent__:nuage.tpl.BaseContext,__impl__:{__init__:function(self,dict_){nuage.tpl.BaseContext.__init__(self,dict_)},has_key:function(self,k){return self.dicts.get(-1).has_key(k)},get:function(self,k,otherwise){var d=self.dicts.get(-1);if(self.dicts.get(-1).has_key(k)){return d.get(k)}return otherwise}}});nuage.create_class({__module__:"nuage.tpl",__name__:"VariableDoesNotExist",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"Node",__impl__:{__init__:function(self,must_be_first){self.must_be_first=must_be_first||false},__iter__:function(self){return self},next:function(self){return self},render:function(self,context){return defer.succeed("")},get_nodes_by_type:function(self,node_type){var nodes=list();if(isinstance(self,node_type)){nodes.append(self)}if(hasattr(self,"nodelist")){nodes.extend(self.nodelist.get_nodes_by_type(node_type))}return nodes}}});nuage.create_class({__module__:"nuage.tpl",__name__:"TextNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,s){self.s=s},render:function(self,context){return defer.succeed(self.s)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"VariableNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,filter_expression){self.filter_expression=filter_expression},render:function(self,context){return self.filter_expression.resolve(context).add_callback(function(result){if((context.autoescape&&!isinstance(result,nuage.tpl.SafeData))||isinstance(result,nuage.tpl.EscapeData)){return nuage.tpl.escape(result)}return result})}}});nuage.create_class({__module__:"nuage.tpl",__name__:"CommentNode",__parent__:nuage.tpl.Node,__impl__:{render:function(self,context){return defer.succeed("")}}});nuage.create_class({__module__:"nuage.tpl",__name__:"IfNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,var_,nodelist_true,nodelist_false){self.var_=var_;self.nodelist_true=nodelist_true;self.nodelist_true.debug=true;self.nodelist_false=nodelist_false;self._next_pos=0;self._treat_true=true},__iter__:function(self){return self},next:function(self){if(self._treat_true){if(self._next_pos<len(self.nodelist_true)){return self.nodelist_true.get(self._next_pos)}else{self._next_pos=[0];self._treat_true=false}}if(!self._treat_true){if(self._next_pos<len(self.nodelist_false)){return self.nodelist_false.get(self._next_pos)}else{}}self._next_pos++},get_nodes_by_type:function(self,node_type){nodes=list();if(isinstance(self,node_type)){nodes.append(self)}nodes.extend(self.nodelist_true.get_nodes_by_type(node_type));nodes.extend(self.nodelist_false.get_nodes_by_type(node_type));return nodes},render:function(self,context){return self.var_.eval(context).add_callback(function(result){if(result){return self.nodelist_true.render(context)}else{return self.nodelist_false.render(context)}})}}});nuage.create_class({__module__:"nuage.tpl",__name__:"ForNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,loopvars,sequence,is_reversed,nodelist_loop,nodelist_empty){nuage.tpl.Node.__init__(self,false);self.loopvars=loopvars;self.sequence=sequence;self.is_reversed=is_reversed;self.nodelist_loop=nodelist_loop;self.nodelist_empty=nodelist_empty||nuage.tpl.NodeList();self._next_pos=0;self._treat_for=true},__iter__:function(self){return self},next:function(self){print("fornode.next");if(self._treat_true){if(self._next_pos<len(self.nodelist_loop)){return self.nodelist_loop.get(self._next_pos)}else{self._next_pos=[0];self._treat_true=false}}if(!self._treat_true){if(self._next_pos<len(self.nodelist_empty)){return self.nodelist_empty.get(self._next_pos)}else{}}self._next_pos++},get_nodes_by_type:function(self,nodetype){nodes=list();if(isinstance(self,nodetype)){nodes.append(self)}nodes.extend(self.nodelist_loop.get_nodes_by_type(nodetype));nodes.extend(self.nodelist_empty.get_nodes_by_type(nodetype));return nodes},render:function(self,context){var values=null;if(context.has_key("forloop")){var parentloop=context.get("forloop")}else{var parentloop=dict()}context.push();return self.sequence.resolve(context,true).add_callback(function(values){if(values==null){values=[]}if(!isinstance(values,dict)&&!isinstance(values,list)){values=list(values)}var len_values=len(values);if(len_values<1){context.pop();return self.nodelist_empty.render(context)}var nodelist=nuage.tpl.NodeList();if(self.is_reversed){print("todo: is_reversed ForNode")}var unpack=len(self.loopvars)>1;var loop_dict={parentloop:parentloop};for(var i=0;i<len_values;i++){var item=values.get(i);loop_dict.counter0=i;loop_dict.counter=i+1;loop_dict.revcounter=len_values-i;loop_dict.revcounter0=len_values-i-1;loop_dict.first=(i==0);loop_dict.last=(i==len_values-1);context.set("forloop",loop_dict);if(unpack){context.push();for(var j=0,l=len(self.loopvars);j<l;j++){context.set(self.loopvars[j],item[self.loopvars[j]])}}else{context.set(self.loopvars[0],item)}for(var j=0,len_=len(self.nodelist_loop);j<len_;j++){var node=self.nodelist_loop.get(j);nodelist.append(node.render(context))}if(unpack){context.pop()}}context.pop();return nodelist.render(context)}).add_errback(function(err){pprint(err);return""})}}});nuage.create_class({__module__:"nuage.tpl",__name__:"NodeList",__parent__:list,__impl__:{__init__:function(self){list.__init__(self,[]);self.contains_nontext=false;self.debug=false},render:function(self,context){function _cb(result){return"".join(result)}function _eb(fail){print("NodeList.render: {0}".format(fail.get_error_message()))}var length=len(self._values);if(length){var bits=list();for(var i=0;i<length;i++){if(isinstance(self._values[i],nuage.tpl.Node)){bits.append(self.render_node(self._values[i],context))}else{bits.append(self._values[i])}}return defer.DeferredList(bits).add_callback(_cb).add_errback(_eb)}else{return defer.succeed("")}},get_nodes_by_type:function(self,nodetype){var nodes=list();for(var i=0,length=len(self._values);i<length;i++){nodes.extend(self._values[i].get_nodes_by_type(nodetype))}return nodes},render_node:function(self,node,context){return node.render(context)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"TokenBase",__impl__:{__init__:function(self){self.id=null;self.value=null;self.first=null;self.second=null},ned:function(self){},led:function(self){},display:function(self){return self.id}}});nuage.create_class({__module__:"nuage.tpl",__name__:"Literal",__parent__:nuage.tpl.TokenBase,__impl__:{__init__:function(self,value){nuage.tpl.TokenBase.__init__(self);self.id="literal";self.lbp=0;self.value=value},display:function(self){return self.value.toString()},nud:function(self,parser){return self},eval:function(self,context){return defer.succeed(self.value)}}});nuage.create_class({__module__:"nuage.tpl.smartif",__name__:"EndToken",__parent__:nuage.tpl.TokenBase,__impl__:{__init__:function(self){nuage.tpl.TokenBase.__init__(self);self.lbp=0},nud:function(self,parser){throw parser.error_class("Unexpected end of expression in if tag.")}}});nuage.create_module({__name__:"nuage.tpl.smartif",__impl__:{EndToken:nuage.tpl.smartif.EndToken(),infix:function(op,bp,func){nuage.create_class({__module__:"nuage.tpl.smartif",__name__:"Operator_"+op,__parent__:nuage.tpl.TokenBase,__impl__:{__init__:function(self){self.lbp=bp},led:function(self,left,parser){self.first=left;self.second=parser.expression(bp);return self},eval:function(self,context){try{return defer.DeferredList(list([self.first.eval(context),self.second.eval(context)])).add_callback(function(result){return func(result.get(0),result.get(1))})}catch(exc){pprint("Operator_"+op,"eval exception",exc);return defer.succed("")}}}});return nuage.tpl.smartif["Operator_"+op]},prefix:function(op,bp,func){nuage.create_class({__module__:"nuage.tpl.smartif",__name__:"Operator_"+op,__parent__:nuage.tpl.TokenBase,__impl__:{__init__:function(self){self.lbp=bp},nud:function(self,parser){self.first=parser.expression(bp);self.second=null;return self},eval:function(self,context){try{return self.first.eval(context).add_callback(func).add_errback(function(err){pprint(err)})}catch(exc){pprint(exc);return false}}}});return nuage.tpl.smartif["Operator_"+op]}}});nuage.tpl.smartif.OPERATORS=dict({or:nuage.tpl.smartif.infix("or",6,function(x,y){return x||y}),and:nuage.tpl.smartif.infix("and",7,function(x,y){return x&&y}),not:nuage.tpl.smartif.prefix("not",8,function(x){return !x}),"in":nuage.tpl.smartif.infix("in",9,function(x,y){return y.index(x)>=0}),"=":nuage.tpl.smartif.infix("eq",10,function(x,y){return x==y}),"==":nuage.tpl.smartif.infix("eq",10,function(x,y){return x==y}),"!=":nuage.tpl.smartif.infix("neq",10,function(x,y){return x!=y}),">":nuage.tpl.smartif.infix("gt",10,function(x,y){return x>y}),">=":nuage.tpl.smartif.infix("gte",10,function(x,y){return x>=y}),"<":nuage.tpl.smartif.infix("lt",10,function(x,y){return x<y}),"<=":nuage.tpl.smartif.infix("tle",10,function(x,y){return x<=y})});nuage.create_class({__name__:"IfParser",__module__:"nuage.tpl.smartif",__impl__:{__init__:function(self,tokens,__args){self.error_class=exc.ValueError;self.tokens=map(self.translate_token,tokens);self.pos=0;self.current_token=self.next()},translate_token:function(self,token){try{var op=nuage.tpl.smartif.OPERATORS.get(token)}catch(e){if(isinstance(e,exc.KeyError)||isinstance(e,exc.TypeError)){return self.create_var(token)}}return op()},next:function(self){if(self.pos>=len(self.tokens)){return nuage.tpl.smartif.EndToken}else{var retval=self.tokens.get(self.pos);self.pos+=1;return retval}},parse:function(self){var retval=self.expression();if(self.current_token!==nuage.tpl.smartif.EndToken){throw self.error_class("Unused '{0}' at end of if expression.".format(self.current_token.display()))}return retval},expression:function(self,rbp){rbp=rbp||0;var t=self.current_token;self.current_token=self.next();var left=t.nud(self);while(rbp<self.current_token.lbp){t=self.current_token;self.current_token=self.next();left=t.led(left,self)}return left},create_var:function(self,value){return nuage.tpl.Literal(value)}}});nuage.create_class({__name__:"TemplateLiteral",__parent__:nuage.tpl.Literal,__module__:"nuage.tpl",__impl__:{__init__:function(self,value,text){self.value=value;self.text=text},display:function(self){return self.text},eval:function(self,context){return self.value.resolve(context,true)}}});nuage.create_class({__name__:"TemplateIfParser",__module__:"nuage.tpl",__parent__:nuage.tpl.smartif.IfParser,__impl__:{__init__:function(self,parser,tokens,__args){self.template_parser=parser;nuage.tpl.smartif.IfParser.__init__(self,tokens);self.error_class=nuage.tpl.TemplateSyntaxError},create_var:function(self,value){return nuage.tpl.TemplateLiteral(self.template_parser.compile_filter(value),value)}}});nuage.create_class({__module__:"nuage.tpl",__name__:"ExtendsError",__parent__:exc.Exception});nuage.create_class({__module__:"nuage.tpl",__name__:"BlockContext",__impl__:{__init__:function(self){self.blocks=dict()},add_blocks:function(self,blocks){var k=blocks.keys();for(var i=0,l=len(k);i<l;i++){var name=k.get(i);var block=blocks.get(name);if(self.blocks.keys().index(name)>=0){self.blocks.get(name).insert(0,block);self.blocks.set(name,self.blocks.get(name))}else{self.blocks.set(name,list([block]))}}},pop:function(self,name){try{return self.blocks.get(name).pop()}catch(e){if(isinstance(e,exc.IndexError)||isinstance(e,exc.KeyError)){return null}throw e}},push:function(self,name,block){var l=self.blocks.get(name);if(l==null){l=list()}self.blocks.set(name,l.append(block))},get_block:function(self,name){try{return self.blocks.get(name).get(-1)}catch(e){if(isinstance(e,exc.IndexError)||isinstance(e,exc.KeyError)){return null}throw e}}}});nuage.create_class({__module__:"nuage.tpl",__name__:"BlockNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,name,nodelist,parent){self.name=name;self.nodelist=nodelist;self.parent=parent||null},__repr__:function(self){return"<BlockNode {0}>".format(self.name)},render:function(self,context){var result="";var block_context=context.render_context.get(nuage.tpl.BLOCK_CONTEXT_KEY);context.push();if(block_context==null){context.set("block",self);result=self.nodelist.render(context)}else{var push=block_context.pop(self.name);var block=push;if(block==null){block=self}block=nuage.tpl.BlockNode(block.name,push.nodelist);block.context=context;context.set("block",block);result=block.nodelist.render(context).add_callback(function(result){if(push!=null){block_context.push(self.name,push)}return result})}return result.add_callback(function(result){context.pop();return result})},super_:function(self){var render_context=self.context.render_context;if(render_context.has_key(nuage.tpl.BLOCK_CONTEXT_KEY)&&render_context.get(nuage.tpl.BLOCK_CONTEXT_KEY).get_block(self.name)!=null){return self.render(self.context).add_callback(function(result){return nuage.tpl.mark_safe(result)})}return defer.suceed("")}}});nuage.create_class({__module__:"nuage.tpl",__name__:"ExtendsNode",__parent__:nuage.tpl.Node,__static__:{must_be_first:true},__impl__:{__init__:function(self,nodelist,parent_name,parent_name_expr){self.nodelist=nodelist;self.parent_name=parent_name;self.parent_name_expr=parent_name_expr;self.blocks=dict();var nl=nodelist.get_nodes_by_type(nuage.tpl.BlockNode);for(var i=0,l=len(nl);i<l;i++){self.blocks.set(nl.get(i).name,nl.get(i))}},__repr__:function(self){if(self.parent_name_expr){return"<ExtendsNode {0}>".format(self.parent_name_expr.token)}return"<ExtendsNode {0}>".format(self.parent_name)},get_parent:function(self,context){if(self.parent_name_expr){var d=self.parent_name_expr.resolve(context)}else{var d=defer.succeed(self.parent_name)}return d.add_callback(function(parent){if(!parent){var error_msg="Invalid template name in 'extends' tag {0} ".format(parent);if(self.parent_name_expr){error_msg+=" Got this from the '{0}' variable.".format(self.parent_name_expr.token)}throw TemplateSyntaxError(error_msg)}if(hasattr(parent,"render")){return defer.succeed(parent)}return nuage.tpl.get_template(parent)})},render:function(self,context){var r=self.get_parent(context).add_callback(function(compiled_parent){if(!context.render_context.has_key(nuage.tpl.BLOCK_CONTEXT_KEY)){context.render_context.set(nuage.tpl.BLOCK_CONTEXT_KEY,nuage.tpl.BlockContext())}var block_context=context.render_context.get(nuage.tpl.BLOCK_CONTEXT_KEY);block_context.add_blocks(self.blocks);for(var i=0,l=len(compiled_parent.nodelist);i<l;i++){var node=compiled_parent.nodelist.get(i);if(!isinstance(node,nuage.tpl.TextNode)){if(!isinstance(node,nuage.tpl.ExtendsNode)){var blocks=dict();var nl=compiled_parent.nodelist.get_nodes_by_type(nuage.tpl.BlockNode);for(var j=0,l2=len(nl);j<l2;j++){blocks.set(nl.get(j).name,nl.get(j))}block_context.add_blocks(blocks)}break}}return compiled_parent.nodelist.render(context)}).add_errback(function(failure){pprint("eb get_parent.render",failure)});return r}}});nuage.create_class({__module__:"nuage.tpl",__name__:"ConstantIncludeNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,name){try{self.template_name=name}catch(e){self.template_name=null}},render:function(self,context){if(self.template_name){return nuage.tpl.get_template(self.template_name).add_callback(function(result){return result.render(context)})}else{return defer.succeed("")}}}});nuage.create_class({__module__:"nuage.tpl",__name__:"IncludeNode",__parent__:nuage.tpl.Node,__impl__:{__init__:function(self,template_name){self.template_name=nuage.tpl.Variable(template_name)},render:function(self,context){return self.template_name.resolve(context).add_callback(nuage.tpl.get_template).add_callback(function(result){return result.render(context)}).add_errback(function(err){pprint(err);return""})}}});